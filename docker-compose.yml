# ===================================================================
# Docker Compose Configuration
# XAU/USD Predictive Analytics Engine - NEYDRA Platform
# Orchestrates:  Python API, PostgreSQL, Redis, Webhook Handler
# Founder & CEO: Ilyes Jarray
# Â© 2025 - All Rights Reserved
# ===================================================================

version: '3.9'

# ===================================================================
# SERVICES
# ===================================================================

services:
  # ===== POSTGRESQL DATABASE =====
  postgres:
    image: postgres:15-alpine
    container_name: neydra-postgres
    restart: unless-stopped
    
    # Environment Variables
    environment:
      POSTGRES_DB: ${POSTGRES_DATABASE:-neydra}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD:  ${POSTGRES_PASSWORD:-neydra_secure_password}
      POSTGRES_INITDB_ARGS: >
        --encoding=UTF8
        --locale=en_US.UTF-8
        --shared_buffers=256MB
        --max_connections=200
        --effective_cache_size=1GB
      
      PGDATA: /var/lib/postgresql/data/pgdata
    
    # Ports
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    
    # Volumes
    volumes: 
      - postgres_data:/var/lib/postgresql/data
      - ./backend/database/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql:ro
      - ./backend/database/init_seed.sql:/docker-entrypoint-initdb.d/02-seed.sql:ro
    
    # Health Check
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    
    # Networks
    networks:
      - neydra-network
    
    # Logging
    logging:
      driver:  "json-file"
      options: 
        max-size: "10m"
        max-file: "3"
    
    # Security
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only_filesystem: false
    
    labels:
      description: "PostgreSQL Database for NEYDRA"
      version: "15"

  # ===== REDIS CACHE =====
  redis: 
    image: redis:7-alpine
    container_name: neydra-redis
    restart:  unless-stopped
    
    # Command with configuration
    command: >
      redis-server
      --appendonly yes
      --maxmemory ${REDIS_MAX_MEMORY:-512mb}
      --maxmemory-policy allkeys-lru
      --timeout 300
      --tcp-keepalive 60
      --databases 16
      --save 900 1
      --save 300 10
      --save 60 10000
    
    # Ports
    ports:
      - "${REDIS_PORT:-6379}:6379"
    
    # Volumes
    volumes:
      - redis_data:/data
    
    # Health Check
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout:  5s
      retries:  5
      start_period:  30s
    
    # Networks
    networks:
      - neydra-network
    
    # Logging
    logging: 
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    
    # Security
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    
    labels:
      description: "Redis Cache for NEYDRA"
      version: "7"

  # ===== PYTHON API SERVER =====
  api:
    build: 
      context: .
      dockerfile: Dockerfile
      args:
        PYTHON_VERSION: ${PYTHON_VERSION:-3.11}
        ENVIRONMENT: ${ENVIRONMENT:-production}
    
    container_name: neydra-api
    restart: unless-stopped
    
    # Environment Variables
    environment:
      # Flask/API Settings
      FLASK_APP: backend/app.py
      FLASK_ENV: ${ENVIRONMENT:-production}
      FLASK_DEBUG:  ${DEBUG:-false}
      API_HOST: 0.0.0.0
      API_PORT: ${API_PORT:-5000}
      WORKERS: ${WORKERS:-4}
      
      # Database
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DATABASE: ${POSTGRES_DATABASE:-neydra}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-neydra_secure_password}
      
      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_DB: 0
      REDIS_ENABLED: "true"
      
      # Broker APIs
      OANDA_ENABLED: ${OANDA_ENABLED:-true}
      OANDA_API_KEY: ${OANDA_API_KEY:-}
      OANDA_ACCOUNT_ID:  ${OANDA_ACCOUNT_ID:-}
      ALPHAVANTAGE_ENABLED: ${ALPHAVANTAGE_ENABLED:-true}
      ALPHAVANTAGE_API_KEY: ${ALPHAVANTAGE_API_KEY:-}
      FINNHUB_ENABLED:  ${FINNHUB_ENABLED:-true}
      FINNHUB_API_KEY: ${FINNHUB_API_KEY:-}
      IEX_ENABLED: ${IEX_ENABLED:-false}
      IEX_API_KEY: ${IEX_API_KEY:-}
      
      # Security
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-change-this-secret-key-in-production}
      API_KEYS: ${API_KEYS:-{}}
      
      # Webhooks
      WEBHOOK_SECRET_KEY: ${WEBHOOK_SECRET_KEY:-webhook-secret-key}
      WEBHOOK_ALLOWED_IPS: ${WEBHOOK_ALLOWED_IPS:-127.0.0.1,localhost}
      
      # Notifications
      SLACK_WEBHOOK_URL: ${SLACK_WEBHOOK_URL:-}
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:-}
      TELEGRAM_CHAT_ID: ${TELEGRAM_CHAT_ID:-}
      EMAIL_ENABLED: ${EMAIL_ENABLED:-false}
      EMAIL_SMTP_HOST: ${EMAIL_SMTP_HOST:-smtp.gmail.com}
      EMAIL_SMTP_PORT: ${EMAIL_SMTP_PORT:-587}
      EMAIL_SENDER: ${EMAIL_SENDER:-}
      EMAIL_PASSWORD: ${EMAIL_PASSWORD:-}
      EMAIL_RECIPIENT: ${EMAIL_RECIPIENT:-}
      
      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      CONSOLE_OUTPUT: "true"
      
      # ML Models
      MODELS_DIR: /app/backend/models
      LOOK_BACK_WINDOW: ${LOOK_BACK_WINDOW:-20}
      HISTORICAL_DAYS: ${HISTORICAL_DAYS:-365}
      
      # Performance
      RATE_LIMIT_RPM: ${RATE_LIMIT_RPM:-100}
      RATE_LIMIT_RPH: ${RATE_LIMIT_RPH:-5000}
      REQUEST_TIMEOUT: ${REQUEST_TIMEOUT:-30}
      
      # Deployment
      ENVIRONMENT: ${ENVIRONMENT:-production}
    
    # Ports
    ports:
      - "${API_PORT:-5000}:5000"
    
    # Volumes
    volumes:
      - ./backend:/app/backend
      - ./logs:/app/logs
      - model_cache:/app/backend/models
      - cache_data:/app/cache
    
    # Working Directory
    working_dir: /app
    
    # Command
    command: >
      sh -c "
      python backend/database/init_db.py --host postgres --no-create-db &&
      gunicorn
        --bind 0.0.0.0:5000
        --workers ${WORKERS:-4}
        --worker-class sync
        --worker-connections 1000
        --max-requests 1000
        --max-requests-jitter 100
        --timeout 120
        --keepalive 5
        --log-level info
        backend.app:app
      "
    
    # Dependencies
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition:  service_healthy
    
    # Health Check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout:  10s
      retries:  3
      start_period:  60s
    
    # Networks
    networks:
      - neydra-network
    
    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
    
    # Resource Limits
    deploy:
      resources:
        limits:
          cpus: ${API_CPU_LIMIT:-2}
          memory: ${API_MEMORY_LIMIT:-2G}
        reservations:
          cpus: ${API_CPU_RESERVE:-1}
          memory: ${API_MEMORY_RESERVE:-1G}
    
    # Security
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only_filesystem: false
    security_opt:
      - no-new-privileges:true
    
    labels:
      description: "NEYDRA XAU/USD Predictive Analytics Engine API"
      version: "1.0.0"
      maintainer: "Ilyes Jarray"

  # ===== WEBHOOK HANDLER SERVICE =====
  webhook: 
    image: php:8.2-fpm-alpine
    container_name: neydra-webhook
    restart: unless-stopped
    
    # Environment Variables
    environment: 
      PHP_MEMORY_LIMIT: 512M
      PHP_MAX_EXECUTION_TIME: 300
      PHP_UPLOAD_MAX_FILESIZE: 100M
      PHP_POST_MAX_SIZE: 100M
      
      # Webhook Security
      WEBHOOK_SECRET_KEY: ${WEBHOOK_SECRET_KEY:-webhook-secret-key}
      OANDA_WEBHOOK_SECRET:  ${OANDA_WEBHOOK_SECRET:-}
      
      # Database
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ${POSTGRES_DATABASE:-neydra}
      DB_USER: ${POSTGRES_USER:-postgres}
      DB_PASSWORD: ${POSTGRES_PASSWORD:-neydra_secure_password}
      
      # Notifications
      SLACK_WEBHOOK_URL: ${SLACK_WEBHOOK_URL:-}
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:-}
      TELEGRAM_CHAT_ID: ${TELEGRAM_CHAT_ID:-}
    
    # Ports
    ports:
      - "${WEBHOOK_PORT:-9000}:9000"
    
    # Volumes
    volumes:
      - ./backend/api:/app/api
      - ./backend/database:/app/database
      - ./logs:/app/logs
    
    # Working Directory
    working_dir: /app
    
    # Dependencies
    depends_on:
      postgres:
        condition: service_healthy
    
    # Health Check
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9000/webhook/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    
    # Networks
    networks:
      - neydra-network
    
    # Logging
    logging: 
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "3"
    
    labels:
      description: "NEYDRA Webhook Handler Service"
      version: "1.0.0"

  # ===== NGINX REVERSE PROXY =====
  nginx:
    image: nginx: 1.25-alpine
    container_name:  neydra-nginx
    restart: unless-stopped
    
    # Ports
    ports: 
      - "${NGINX_HTTP_PORT:-80}:80"
      - "${NGINX_HTTPS_PORT:-443}:443"
    
    # Volumes
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - nginx_cache:/var/cache/nginx
    
    # Dependencies
    depends_on:
      - api
      - webhook
    
    # Networks
    networks:
      - neydra-network
    
    # Health Check
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    
    # Logging
    logging:
      driver: "json-file"
      options: 
        max-size: "20m"
        max-file: "3"
    
    labels:
      description: "NEYDRA Nginx Reverse Proxy"
      version: "1.25"

  # ===== PGADMIN (Optional - Development) =====
  pgadmin:
    image: dpage/pgadmin4:7
    container_name: neydra-pgadmin
    restart:  unless-stopped
    
    # Only in development
    profiles:
      - dev
    
    # Environment Variables
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@neydra.io}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin}
      PGADMIN_CONFIG_SERVER_MODE: "False"
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: "False"
    
    # Ports
    ports:
      - "5050:80"
    
    # Volumes
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    
    # Dependencies
    depends_on:
      - postgres
    
    # Networks
    networks:
      - neydra-network
    
    labels:
      description: "PgAdmin Database Management Interface (Dev Only)"

  # ===== REDIS COMMANDER (Optional - Development) =====
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: neydra-redis-commander
    restart: unless-stopped
    
    # Only in development
    profiles: 
      - dev
    
    # Environment Variables
    environment: 
      REDIS_HOSTS: local:redis:6379
    
    # Ports
    ports:
      - "8081:8081"
    
    # Dependencies
    depends_on:
      - redis
    
    # Networks
    networks:
      - neydra-network
    
    labels:
      description: "Redis Commander Interface (Dev Only)"

# ===================================================================
# VOLUMES
# ===================================================================

volumes: 
  postgres_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${POSTGRES_DATA_DIR:-./data/postgres}
  
  redis_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${REDIS_DATA_DIR:-./data/redis}
  
  model_cache:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${MODEL_CACHE_DIR:-./data/models}
  
  cache_data:
    driver: local
    driver_opts:
      type:  none
      o: bind
      device: ${CACHE_DATA_DIR:-./data/cache}
  
  pgadmin_data:
    driver: local
  
  nginx_cache:
    driver: local

# ===================================================================
# NETWORKS
# ===================================================================

networks: 
  neydra-network: 
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: br_neydra
      com.docker.network.bridge.enable_ip_masquerade: "true"
      com. docker.network.bridge.enable_icc: "true"
    ipam:
      config:
        - subnet: 172.21.0.0/16
          gateway: 172.21.0.1

# ===================================================================
# GLOBAL SETTINGS
# ===================================================================

# Default compose file settings
x-default-environment: &default-env
  TZ: UTC
  PYTHONUNBUFFERED: "1"
  PYTHONDONTWRITEBYTECODE: "1"

# Default logging driver
x-default-logging: &default-logging
  driver: json-file
  options:
    max-size: "10m"
    max-file: "3"
    labels:  "service={{.Name}}"

# Default resource limits
x-resource-limits: &resource-limits
  deploy:
    resources:
      limits:
        cpus: "2"
        memory: 2G
      reservations: 
        cpus: "1"
        memory: 1G

# ===================================================================
# NOTES & INSTRUCTIONS
# ===================================================================
# 
# To start services:
#   docker-compose up -d
#
# To start with development services (pgAdmin, Redis Commander):
#   docker-compose --profile dev up -d
#
# To view logs:
#   docker-compose logs -f api
#   docker-compose logs -f postgres
#   docker-compose logs -f webhook
#
# To execute commands in containers:
#   docker-compose exec api bash
#   docker-compose exec postgres psql -U postgres -d neydra
#
# To stop services:
#   docker-compose down
#
# To remove all data:
#   docker-compose down -v
#
# To rebuild images:
#   docker-compose build --no-cache
#
# Health check status:
#   docker-compose ps
#
# Performance monitoring:
#   docker stats
#
# ===================================================================